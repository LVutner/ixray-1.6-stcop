#include "common.h"
#include "lmodel.h"
#include "shadow.h"
#include "ScreenSpaceContactShadows.hlsli"

float4 main ( float4 tc : TEXCOORD0, float4 tcJ : TEXCOORD1 ) : COLOR
{
	float4 _P = tex2Dproj (s_position, tc);
	float4 _N = tex2Dproj (s_normal, tc);
	_N.xyz = normalize(_N.xyz);

	// ----- light-model
	float m = xmaterial;
	
	#ifndef USE_R2_STATIC_SUN
		m = _P.w;
	#endif
	
	float4 light = plight_infinity (m,_P,_N,Ldynamic_dir);

	// ----- shadow
	float4 P4 = float4 (_P.xyz + _N.xyz * 0.05, 1.0f);
	float4 PS = mul (m_shadow, P4);
	float s = sunmask (P4);
	
	#if SUN_QUALITY==2
		s *= shadow_high (PS)
	#else
		s *= shadow (PS);
	#endif

	RayTraceContactShadow(tc.xy / tc.w, _P, _N, Ldynamic_dir, s);

	return blend (Ldynamic_color * light * s, tc);
}
